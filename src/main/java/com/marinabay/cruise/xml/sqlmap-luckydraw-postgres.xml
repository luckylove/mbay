<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.marinabay.cruise.dao.LuckyDrawDao" >

  <resultMap id="mapResult" type="com.marinabay.cruise.model.LuckyDraw" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="user_name" property="userName" jdbcType="VARCHAR" />
    <result column="trigger_time" property="triggerTime" jdbcType="TIMESTAMP" />
    <result column="user_id" property="userId" jdbcType="BIGINT" />
  </resultMap>


  <sql id="Base_Column_List" >
    id, content, trigger_time, user_id
  </sql>
  <sql id="Base_Column_List_Alias" >
    ug.id, ug.content, ug.trigger_time, ug.user_id
  </sql>

 <select id="count" resultType="long" parameterType="pagingModel" >
    select count(id) as total
    from luckydraw
     where 1=1
 </select>

  <select id="select" resultMap="mapResult" parameterType="pagingModel" >
    select
    <include refid="Base_Column_List_Alias" /> , us.user_name
    from luckydraw ug left outer join users us on ug.user_id = us.id
      where 1=1
      order by trigger_time desc
  <if test="limit > 0" >
      limit ${limit} offset ${offset}
  </if>

  </select>
  
  <select id="selectByID" resultMap="mapResult" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from luckydraw
    where id = #{value}
  </select>

  <delete id="deleteByID" parameterType="java.lang.Long" >
    delete from luckydraw
    where id = #{value}
  </delete>

  <insert id="insert" parameterType="taxiModel" >

      <selectKey keyProperty="id"
                 resultType="java.lang.Long" order="BEFORE">
          SELECT nextVal('luckydraw_id_seq')
      </selectKey>

    insert into luckydraw (id, content, trigger_time, user_id)
    values (
    	#{id,jdbcType=BIGINT},
    	#{content,jdbcType=VARCHAR},
    	#{triggerTime,jdbcType=TIMESTAMP},
    	#{userId,jdbcType=TIMESTAMP}
      )
      
  </insert>

  <update id="randomUser" parameterType="long">
    update luckydraw
    set user_id = (select id from users offset floor(random() * (select count(*) from users)) limit 1 )
    where id = #{id,jdbcType=BIGINT}
  </update>

  <select id="selectNotRun" resultMap="mapResult" parameterType="pagingModel">
    select
    <include refid="Base_Column_List" />
    from luckydraw ug
    where 1=1 AND user_id is null AND trigger_time::date >= now()::date
  </select>
</mapper>